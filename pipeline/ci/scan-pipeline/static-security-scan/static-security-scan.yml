default:
  image: quay.io/bastiaanvanderbijl/docker:26.1.3
 
grype-scan:
  stage: scan-pipeline:static-security-scan
  needs: [verify-image]
  services:
    - name: quay.io/bastiaanvanderbijl/docker:26.1.3-dind
      alias: docker-dind-grype
  variables:
    DOCKER_HOST: tcp://docker-dind-grype:2375/
  before_script:
    - while ! docker info; do sleep 1; done 
  script:
    - mkdir -p reports
    - >
      if ! docker run --rm quay.io/bastiaanvanderbijl/grype $IMAGE_NAME:$IMAGE_TAG -o json > reports/grype-report.json; then
        echo "Grype scan failed. See the job log for details." >&2
        exit 1
      fi
  artifacts:
    paths:
      - reports/
  allow_failure: false
  after_script:
    - docker container prune -f
    - docker image prune -f
  rules:
    - if: '$CI_COMMIT_TAG == "scan-pipeline"'

clair-scan:
  stage: scan-pipeline:static-security-scan
  needs: [verify-image]
  services:
    - name: quay.io/bastiaanvanderbijl/docker:26.1.3-dind
      alias: docker-dind-clair
  variables:
    DOCKER_HOST: tcp://docker-dind-clair:2375/
  before_script:
    - while ! docker info; do sleep 1; done 
  script:
    - mkdir -p reports
    - >
      if ! docker run --rm quay.io/bastiaanvanderbijl/clairctl-debian report --out json --host http://172.20.0.5:6060 $IMAGE_NAME:$IMAGE_TAG > reports/clair-report.json; then
        echo "Clair scan failed. See the job log for details." >&2
        exit 1
      fi
  artifacts:
    paths:
      - reports/
  allow_failure: false
  after_script:
    - docker container prune -f
    - docker image prune -f
  rules:
    - if: '$CI_COMMIT_TAG == "scan-pipeline"'

trivy-scan:
  stage: scan-pipeline:static-security-scan
  needs: [verify-image]
  services:
    - name: quay.io/bastiaanvanderbijl/docker:26.1.3-dind
      alias: docker-dind-trivy
  variables:
    DOCKER_HOST: tcp://docker-dind-trivy:2375/
  before_script:
    - while ! docker info; do sleep 1; done 
  script:
    - mkdir -p reports
    - >
      if ! docker run --rm quay.io/bastiaanvanderbijl/trivy image $IMAGE_NAME:$IMAGE_TAG -f json > reports/trivy-report.json; then
        echo "Trivy scan failed. See the job log for details." >&2
        exit 1
      fi
  artifacts:
    paths:
      - reports/
  allow_failure: false
  after_script:
    - docker container prune -f
    - docker image prune -f
  rules:
    - if: '$CI_COMMIT_TAG == "scan-pipeline"'