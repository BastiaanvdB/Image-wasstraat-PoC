upload-to-mongo:
  stage: scan-pipeline:upload-final-combine
  needs:
    - final-combine
  image: quay.io/bastiaanvanderbijl/python:3.12.3-slim
  script:
    - pip install pymongo
    - |
      python - <<EOF
      import json
      from pymongo import MongoClient
      import os
      import os
      from datetime import datetime

      # Load the final combined report
      with open('reports/final_combined_report.json') as f:
          final_combined_data = json.load(f)

      # Add status to the report
      final_combined_data['status'] = "scanned"
      
      # Add a MongoDB timestamp field
      final_combined_data['finished_at'] = datetime.utcnow()

      # Upload the final combined report to MongoDB
      mongo_uri = os.environ.get("MONGO_URI")
      client = MongoClient(mongo_uri)
      db = client["image_wasstraat"]

      collection = db["scanning_reports"]
      collection.insert_one(final_combined_data)

      print("Final combined report uploaded to MongoDB")

      EOF
  dependencies:
    - final-combine
  allow_failure: false
  rules:
    - if: '$CI_COMMIT_TAG == "scan-pipeline"'